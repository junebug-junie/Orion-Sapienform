services:
  recall:
    build:
      context: ../..
      dockerfile: services/orion-recall/Dockerfile
    container_name: ${PROJECT}-recall
    restart: unless-stopped
    networks:
      - app-net
    environment:
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - ORION_BUS_URL=${ORION_BUS_URL}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}

      - RECALL_BUS_INTAKE=${RECALL_BUS_INTAKE}
      - CHANNEL_RECALL_REQUEST=${CHANNEL_RECALL_REQUEST}
      - CHANNEL_RECALL_DEFAULT_REPLY_PREFIX=${CHANNEL_RECALL_DEFAULT_REPLY_PREFIX}

      - HEARTBEAT_INTERVAL_SEC=${HEARTBEAT_INTERVAL_SEC}
      - HEALTH_CHANNEL=${HEALTH_CHANNEL}
      - ERROR_CHANNEL=${ERROR_CHANNEL}
      - SHUTDOWN_GRACE_SEC=${SHUTDOWN_GRACE_SEC}

      - RECALL_DEFAULT_MAX_ITEMS=${RECALL_DEFAULT_MAX_ITEMS}
      - RECALL_DEFAULT_TIME_WINDOW_DAYS=${RECALL_DEFAULT_TIME_WINDOW_DAYS}
      - RECALL_DEFAULT_MODE=${RECALL_DEFAULT_MODE}

      - RECALL_ENABLE_SQL_CHAT=${RECALL_ENABLE_SQL_CHAT}
      - RECALL_ENABLE_SQL_MIRRORS=${RECALL_ENABLE_SQL_MIRRORS}
      - RECALL_ENABLE_VECTOR=${RECALL_ENABLE_VECTOR}
      - RECALL_ENABLE_RDF=${RECALL_ENABLE_RDF}

      # Database & Stores
      - RECALL_PG_DSN=${RECALL_PG_DSN}
      - VECTOR_DB_HOST=${VECTOR_DB_HOST}
      - GRAPHDB_URL=${GRAPHDB_URL}

      - RECALL_SQL_CHAT_TABLE=${RECALL_SQL_CHAT_TABLE}
      - RECALL_SQL_CHAT_TEXT_COL=${RECALL_SQL_CHAT_TEXT_COL}
      - RECALL_SQL_CHAT_RESPONSE_COL=${RECALL_SQL_CHAT_RESPONSE_COL}
      - RECALL_SQL_CHAT_CREATED_AT_COL=${RECALL_SQL_CHAT_CREATED_AT_COL}

      - RECALL_SQL_MIRROR_TABLE=${RECALL_SQL_MIRROR_TABLE}
      - RECALL_SQL_MIRROR_SUMMARY_COL=${RECALL_SQL_MIRROR_SUMMARY_COL}
      - RECALL_SQL_MIRROR_TRIGGER_COL=${RECALL_SQL_MIRROR_TRIGGER_COL}
      - RECALL_SQL_MIRROR_OBSERVER_COL=${RECALL_SQL_MIRROR_OBSERVER_COL}
      - RECALL_SQL_MIRROR_OBSERVER_STATE_COL=${RECALL_SQL_MIRROR_OBSERVER_STATE_COL}
      - RECALL_SQL_MIRROR_FIELD_RESONANCE_COL=${RECALL_SQL_MIRROR_FIELD_RESONANCE_COL}
      - RECALL_SQL_MIRROR_INTENT_COL=${RECALL_SQL_MIRROR_INTENT_COL}
      - RECALL_SQL_MIRROR_TYPE_COL=${RECALL_SQL_MIRROR_TYPE_COL}
      - RECALL_SQL_MIRROR_ENTITY_COL=${RECALL_SQL_MIRROR_ENTITY_COL}
      - RECALL_SQL_MIRROR_MANTRA_COL=${RECALL_SQL_MIRROR_MANTRA_COL}
      - RECALL_SQL_MIRROR_CAUSAL_ECHO_COL=${RECALL_SQL_MIRROR_CAUSAL_ECHO_COL}
      - RECALL_SQL_MIRROR_TS_COL=${RECALL_SQL_MIRROR_TS_COL}

      - RECALL_SQL_ENRICH_TABLE=${RECALL_SQL_ENRICH_TABLE}
      - RECALL_SQL_ENRICH_COLLAPSE_ID_COL=${RECALL_SQL_ENRICH_COLLAPSE_ID_COL}
      - RECALL_SQL_ENRICH_TAGS_COL=${RECALL_SQL_ENRICH_TAGS_COL}
      - RECALL_SQL_ENRICH_ENTITIES_COL=${RECALL_SQL_ENRICH_ENTITIES_COL}
      - RECALL_SQL_ENRICH_SALIENCE_COL=${RECALL_SQL_ENRICH_SALIENCE_COL}
      - RECALL_SQL_ENRICH_TS_COL=${RECALL_SQL_ENRICH_TS_COL}

      - VECTOR_DB_PORT=${VECTOR_DB_PORT}
      - VECTOR_DB_COLLECTION=${VECTOR_DB_COLLECTION}
      - GRAPHDB_REPO=${GRAPHDB_REPO}
      - GRAPHDB_USER=${GRAPHDB_USER}
      - GRAPHDB_PASS=${GRAPHDB_PASS}

      - RECALL_VECTOR_BASE_URL=${RECALL_VECTOR_BASE_URL}
      - RECALL_VECTOR_COLLECTIONS=${RECALL_VECTOR_COLLECTIONS}
      - RECALL_VECTOR_TIMEOUT_SEC=${RECALL_VECTOR_TIMEOUT_SEC}
      - RECALL_VECTOR_MAX_ITEMS=${RECALL_VECTOR_MAX_ITEMS}

      - RECALL_RDF_ENDPOINT_URL=${RECALL_RDF_ENDPOINT_URL}
      - RECALL_RDF_TIMEOUT_SEC=${RECALL_RDF_TIMEOUT_SEC}
      - RECALL_RDF_ENABLE_SUMMARIES=${RECALL_RDF_ENABLE_SUMMARIES}

      - RECALL_TENSOR_RANKER_ENABLED=${RECALL_TENSOR_RANKER_ENABLED}
      - RECALL_TENSOR_RANKER_MODEL_PATH=${RECALL_TENSOR_RANKER_MODEL_PATH}

      - PORT=${PORT}
      - NODE_NAME=${NODE_NAME}
    ports:
      - "${PORT}:${PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT}/health"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3
    command: ["/bin/sh", "-c", "sleep 5 && uvicorn app.main:app --host 0.0.0.0 --port ${PORT}"]

networks:
  app-net:
    external: true
