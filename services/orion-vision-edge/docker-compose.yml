services:
  vision-edge:
    build:
      context: ../..
      dockerfile: services/orion-vision-edge/Dockerfile
    container_name: ${PROJECT:-orion}-vision-edge
    restart: unless-stopped
    env_file:
      - .env

    environment:
      - SOURCE=${REOLINK_URL}
      - WIDTH=${WIDTH}
      - HEIGHT=${HEIGHT}
      - FPS=${FPS}

      - DETECTORS=${DETECTORS}
      - MOTION_MIN_AREA=${MOTION_MIN_AREA}
      - DETECT_EVERY_N_FRAMES=${DETECT_EVERY_N_FRAMES}
      - STREAM_ID=${STREAM_ID}
      - ENABLE_UI=${ENABLE_UI}

      - ENABLE_YOLO=${ENABLE_YOLO}
      - YOLO_MODEL=${YOLO_MODEL}
      - YOLO_CLASSES=${YOLO_CLASSES}
      - YOLO_CONF=${YOLO_CONF}
      - YOLO_CONF_THRES=${YOLO_CONF_THRES}
      - YOLO_IOU_THRES=${YOLO_IOU_THRES}
      - YOLO_IMG_SIZE=${YOLO_IMG_SIZE}
      - YOLO_DEVICE=${YOLO_DEVICE}
      - YOLO_PERSON_RETRY_THRESHOLD=${YOLO_PERSON_RETRY_THRESHOLD}

      - FACE_CASCADE_PATH=${FACE_CASCADE_PATH}
      - FACE_SCALE_FACTOR=${FACE_SCALE_FACTOR}
      - FACE_MIN_NEIGHBORS=${FACE_MIN_NEIGHBORS}
      - FACE_MIN_SIZE=${FACE_MIN_SIZE}

      - ANNOTATE=${ANNOTATE}

      - ENABLE_PRESENCE=${ENABLE_PRESENCE}
      - PRESENCE_TIMEOUT=${PRESENCE_TIMEOUT}
      - PRESENCE_LABEL=${PRESENCE_LABEL}

      - JPEG_QUALITY=${JPEG_QUALITY}

      - ORION_BUS_URL=${ORION_BUS_URL}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}

      - VISION_EVENTS_PUBLISH_RAW=${VISION_EVENTS_PUBLISH_RAW}
      - VISION_EVENTS_SUBSCRIBE_RAW=${VISION_EVENTS_SUBSCRIBE_RAW}
      - VISION_EVENTS_PUBLISH_NOTABLE=${VISION_EVENTS_PUBLISH_NOTABLE}

      - CHANNEL_VISION_FRAMES=${CHANNEL_VISION_FRAMES}
      - CHANNEL_VISION_ARTIFACTS=${CHANNEL_VISION_ARTIFACTS}

      - FRAME_STORAGE_DIR=${FRAME_STORAGE_DIR}
      - EDGE_DEBUG_SAVE_FRAMES=${EDGE_DEBUG_SAVE_FRAMES}
      - EDGE_DEBUG_DIR=${EDGE_DEBUG_DIR}

    volumes:
      - /mnt/telemetry/orion-vision-edge
      - /tmp/orion-frames:/mnt/frames
      - /tmp/orion-debug:/mnt/debug

    ports:
      - "7100:7100"

    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

    networks:
      - app-net

networks:
  app-net:
    external: true
