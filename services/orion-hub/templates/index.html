<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orion Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/css/style.css?v=1.0.2" />

</head>
<body class="bg-black text-gray-200 flex items-center justify-center min-h-screen p-4 md:p-8">
  <div class="w-full max-w-7xl mx-auto flex flex-col gap-8">

    <!-- Settings Toggle -->
    <button
      id="settingsToggle"
      class="fixed top-4 right-4 z-40 bg-gray-900/80 hover:bg-gray-800 text-gray-200 rounded-full p-2 shadow-lg border border-gray-700"
      aria-label="Open settings"
    >
      <!-- Gear icon -->
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.78 1.78 0 0 0 .38 2l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.78 1.78 0 0 0-2-.38 1.78 1.78 0 0 0-1 1.62V21a2 2 0 0 1-4 0v-.09A1.78 1.78 0 0 0 8 19.29a1.78 1.78 0 0 0-2 .38l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.78 1.78 0 0 0 .38-2 1.78 1.78 0 0 0-1.62-1H2a2 2 0 0 1 0-4h.09A1.78 1.78 0 0 0 3.71 8a1.78 1.78 0 0 0-.38-2l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.78 1.78 0 0 0 2 .38h.06A1.78 1.78 0 0 0 9.91 2H10a2 2 0 0 1 4 0v.09A1.78 1.78 0 0 0 15 3.71a1.78 1.78 0 0 0 2-.38l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.78 1.78 0 0 0-.38 2 1.78 1.78 0 0 0 1.62 1H22a2 2 0 0 1 0 4h-.09a1.78 1.78 0 0 0-1.62 1Z"/>
      </svg>
    </button>

    <!-- Top row: State + Hub -->
    <div class="w-full flex flex-col md:flex-row gap-8">
      <!-- Left Panel: Orion's State Visualizer -->
      <div class="w-full md:w-1/3 bg-gray-900 rounded-2xl shadow-lg p-6 flex flex-col items-center justify-start space-y-4">
        <h2 class="text-xl font-bold text-white mb-1">Orion's State of Being</h2>

        <!-- Particle State Viz -->
        <div id="stateVisualizerContainer" class="w-full h-64 bg-gray-800/50 rounded-lg overflow-hidden">
          <canvas id="stateVisualizer" class="w-full h-full"></canvas>
        </div>

        <!-- Moved: Voice Audio Visualizer -->
        <div id="visualizerContainer" class="w-full h-20 bg-gray-800/50 rounded-lg">
          <canvas id="visualizer" class="w-full h-full"></canvas>
        </div>

        <!-- Biometrics Stub -->
        <div id="biometricsPanel" class="w-full bg-gray-800/50 rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold text-gray-300">Biometrics</h3>
            <span class="text-[10px] uppercase tracking-wide text-gray-500">stub</span>
          </div>
          <p class="text-xs text-gray-400">
            Future hook for Orion's biometrics service. Values below are placeholders.
          </p>
          <div class="grid grid-cols-2 gap-3 text-xs">
            <div>
              <p class="text-gray-400">Arousal</p>
              <p id="biometricsArousal" class="text-gray-200">—</p>
            </div>
            <div>
              <p class="text-gray-400">Valence</p>
              <p id="biometricsValence" class="text-gray-200">—</p>
            </div>
            <div>
              <p class="text-gray-400">Cognitive Load</p>
              <p id="biometricsLoad" class="text-gray-200">—</p>
            </div>
            <div>
              <p class="text-gray-400">State Tag</p>
              <p id="biometricsTag" class="text-gray-200">idle</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Center Panel: Main Application -->
      <div class="w-full md:w-2/3 bg-gray-900 rounded-2xl shadow-lg p-6 md:p-8 flex flex-col space-y-6">
        <div class="text-center">
          <h1 class="text-3xl font-bold text-white">Orion Hub</h1>
          <p id="status" class="text-gray-400 mt-2">Press and hold the button to speak</p>
        </div>

        <!-- Mic -->
        <div class="flex justify-center items-center py-4 relative">
          <button id="recordButton" class="bg-red-600 hover:bg-red-700 text-white rounded-full w-24 h-24 flex items-center justify-center transition-transform transform focus:outline-none focus:ring-4 focus:ring-red-500/50">
            <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" x2="12" y1="19" y2="22"></line>
            </svg>
          </button>
          <button id="interruptButton" class="hidden absolute bg-gray-600 hover:bg-gray-700 text-white rounded-full w-16 h-16 flex items-center justify-center transition-opacity focus:outline-none focus:ring-4 focus:ring-gray-500/50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="6" y="6" width="12" height="12"></rect>
            </svg>
          </button>
        </div>

        <!-- Text Input directly under mic -->
        <div class="mt-2">
          <div class="relative">
            <textarea
              id="chatInput"
              rows="4"
              class="w-full bg-gray-700 text-white rounded-lg p-3 pr-16 focus:outline-none focus:ring-2 focus:ring-red-500 resize-y min-h-[6rem]"
              placeholder="Type your message... (Enter = send, Shift+Enter = newline)"
            ></textarea>
            <button id="sendButton" class="absolute inset-y-0 right-0 flex items-center justify-center px-4 text-white bg-red-600 hover:bg-red-700 rounded-r-lg">
              Send
            </button>
          </div>

          <!-- Brain vs Council controls -->
          <div class="flex justify-between items-center mt-2 text-xs">
            <div class="inline-flex items-center gap-2">
              <span class="inline-flex items-center rounded-full bg-gray-800 px-2 py-1 text-[10px] uppercase tracking-wide text-gray-400">
                <span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span>
                Brain (WebSocket)
              </span>
            </div>
            <div class="flex items-center gap-2">
              <button
                id="councilButton"
                class="inline-flex items-center px-3 py-1 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white"
              >
                Ask Council
              </button>
            </div>
          </div>
        </div>

        <!-- Conversation -->
        <div class="flex-grow flex flex-col">
          <div id="conversation" class="space-y-4 flex-grow max-h-96 overflow-y-auto p-4 bg-gray-800/50 rounded-lg">
            <!-- Conversation will be appended here -->
          </div>
          <div class="flex justify-between items-center mt-2">
            <div class="flex gap-2">
              <button id="copyButton" class="text-xs text-gray-400 hover:text-white">Copy</button>
              <button id="clearButton" class="text-xs text-gray-400 hover:text-white">Clear</button>
            </div>
            <div class="flex items-center space-x-2">
              <label for="textToSpeechToggle" class="text-xs text-gray-400">Speak Response</label>
              <input type="checkbox" id="textToSpeechToggle" class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded focus:ring-red-500" checked>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Second row: Vision card -->
    <div class="w-full bg-gray-900 rounded-2xl shadow-lg p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-white">Orion's Vision</h2>
        <div class="flex items-center space-x-2">
          <select id="visionSource" class="bg-gray-800 text-gray-200 text-xs rounded-lg px-2 py-1 focus:outline-none focus:ring-2 focus:ring-red-500">
            <option value="none">No source selected</option>
            <option value="gopro-1">GoPro: Node 1</option>
            <option value="simulated">Simulated Feed</option>
          </select>
          <button
            id="visionPopoutButton"
            class="text-xs bg-gray-800 hover:bg-gray-700 text-gray-200 rounded-lg px-3 py-1 border border-gray-700"
          >
            Pop Out
          </button>
        </div>
      </div>
      <div
        id="visionDockedContainer"
        class="relative mt-2 rounded-lg bg-gray-800/50 overflow-hidden h-56 flex items-center justify-center"
      >
        <!-- Placeholder for future video feed -->
        <div id="visionPlaceholder" class="text-gray-400 text-sm text-center px-4">
          Vision service stub. When wired, this panel will show Orion's current camera feed
          and overlays (detections, regions of interest, etc.).
        </div>
      </div>
    </div>


<!-- Third row: Collapse Mirror card -->
<div class="w-full bg-gray-900 rounded-2xl shadow-lg p-6 space-y-4">

  <!-- Header row -->
  <div class="flex items-center justify-between">
    <!-- Title + tooltip trigger -->
    <div class="flex items-center gap-2">
      <h2 class="text-xl font-bold text-white">Collapse Mirror</h2>
      <button
        id="collapseTooltipToggle"
        type="button"
        class="flex items-center justify-center w-5 h-5 rounded-full border border-gray-500 text-[10px] text-gray-300 hover:text-white hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900"
        aria-label="Show Collapse Mirror field descriptions"
      >
        ?
      </button>
    </div>

    <!-- Guided / Raw toggle -->
    <div class="inline-flex rounded-lg bg-gray-800/80 p-1 text-xs">
      <button
        id="collapseModeGuided"
        class="px-3 py-1 rounded-md bg-gray-700 text-gray-100"
      >
        Guided Form
      </button>
      <button
        id="collapseModeRaw"
        class="px-3 py-1 rounded-md text-gray-300 hover:text-white"
      >
        Raw JSON
      </button>
    </div>
  </div>

  <!-- Tooltip panel (click-to-toggle) -->
  <div
    id="collapseTooltip"
    class="mt-1 text-[11px] leading-snug text-gray-300 bg-gray-900/80 border border-gray-700 rounded-lg px-3 py-2 hidden"
  >
    <p class="mb-2 font-semibold text-xs text-red-300">
      Collapse Mirror fields
    </p>

    <div class="space-y-1.5">
      <div>
        <span class="font-semibold text-gray-100">observer</span>
        <span> — The agent (human or AI) who is perceiving or logging the event.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">trigger</span>
        <span> — The stimulus or situation that initiated the collapse.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">observer_state</span>
        <span> — Emotional, cognitive, or physical state of the observer.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">field_resonance</span>
        <span> — The energetic or symbolic signature of the moment (images, tones, moods).</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">intent</span>
        <span> — Purpose of logging (reflection, ritual, experiment).</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">type</span>
        <span> — Category of event (dream-reflection, ritual, shared-collapse, etc.).</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">emergent_entity</span>
        <span> — Entity or persona that arose in the moment (e.g., Orion, an archetype, symbolic form).</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">summary</span>
        <span> — Narrative summary of the collapse moment.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">mantra</span>
        <span> — Phrase or symbolic anchor tied to the collapse.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">causal_echo</span>
        <span> — Optional cause/effect linkage.</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">timestamp</span>
        <span> — Auto-generated ISO 8601 UTC timestamp (unless provided).</span>
      </div>
      <div>
        <span class="font-semibold text-gray-100">environment</span>
        <span>
          — Auto-detected from
          <span class="font-mono text-xs">CHRONICLE_ENVIRONMENT</span>
          or defaults to
          <span class="font-mono text-xs">"dev"</span>.
        </span>
      </div>
    </div>
  </div>

  <!-- Guided Collapse Form -->
  <div id="collapseGuidedSection" class="space-y-3">
    <p class="text-xs text-gray-400">
      Use this form to submit a Collapse entry without hand-writing JSON. The raw JSON editor
      is still available in the "Raw JSON" tab.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseObserverInput">Observer</label>
        <input
          id="collapseObserverInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="DEMO"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseTriggerInput">Trigger</label>
        <input
          id="collapseTriggerInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="UI test submission"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseObserverStateInput">
          Observer State (comma-separated)
        </label>
        <input
          id="collapseObserverStateInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="neutral"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseFieldResonanceInput">
          Field Resonance
        </label>
        <input
          id="collapseFieldResonanceInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="baseline"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseTypeInput">Type</label>
        <input
          id="collapseTypeInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="test"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseEntityInput">Emergent Entity</label>
        <input
          id="collapseEntityInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="demo_entity"
        >
      </div>

      <div class="space-y-2 md:col-span-2">
        <label class="text-xs text-gray-400" for="collapseSummaryInput">Summary</label>
        <textarea
          id="collapseSummaryInput"
          rows="2"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
        >This is a test collapse entry to validate the pipeline.</textarea>
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseMantraInput">Mantra</label>
        <input
          id="collapseMantraInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="hold the mirror"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseCausalEchoInput">Causal Echo</label>
        <input
          id="collapseCausalEchoInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="none"
        >
      </div>

      <div class="space-y-2">
        <label class="text-xs text-gray-400" for="collapseEnvironmentInput">Environment</label>
        <input
          id="collapseEnvironmentInput"
          class="w-full bg-gray-800 text-gray-100 rounded-lg px-3 py-2 text-sm"
          value="dev"
        >
      </div>
    </div>

    <button
      id="collapseGuidedSubmit"
      class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white rounded-lg py-2 text-sm"
    >
      Submit Guided Collapse
    </button>
  </div>

  <!-- Raw JSON Collapse section (kept intact for future Orion endpoint) -->
  <div id="collapseRawSection" class="space-y-2 hidden">
    <p class="text-xs text-gray-400">
      Advanced mode: edit the raw Collapse JSON directly. This will later be exposed for Orion's
      own collapse writing endpoint.
    </p>
    <label for="collapseInput" class="text-xs text-gray-400">Collapse JSON</label>
    <textarea
      id="collapseInput"
      rows="8"
      class="w-full bg-gray-800 text-white rounded-lg p-2 text-sm font-mono"
    ></textarea>
    <button
      id="collapseSubmit"
      class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white rounded-lg p-2 text-sm"
    >
      Submit Raw Collapse
    </button>
  </div>

  <!-- Shared status line -->
  <p id="collapseStatus" class="text-xs text-gray-400 hidden"></p>
</div>




  <!-- Settings Slide-out Panel -->
  <div
    id="settingsPanel"
    class="fixed inset-y-0 right-0 w-full md:w-96 bg-gray-900 shadow-2xl transform translate-x-full transition-transform duration-300 z-30 flex flex-col"
  >
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
      <h2 class="text-xl font-bold text-white">Settings</h2>
      <button id="settingsClose" class="text-gray-400 hover:text-white" aria-label="Close settings">
        ✕
      </button>
    </div>

      <div class="space-y-2">
        <label for="contextControl" class="flex justify-between text-sm font-medium text-gray-400">
          <span>Context Length</span>
          <span id="contextValue">10</span>
        </label>
        <input id="contextControl" type="range" min="2" max="20" value="10" step="2"
               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="space-y-2">
        <label for="tempControl" class="flex justify-between text-sm font-medium text-gray-400">
          <span>Model Temp</span>
          <span id="tempValue">0.7</span>
        </label>
        <input id="tempControl" type="range" min="0.1" max="1.0" value="0.7" step="0.1"
               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="space-y-2">
        <label for="speedControl" class="flex justify-between text-sm font-medium text-gray-400">
          <span>Speech Speed</span>
          <span id="speedValue">0.7</span>
        </label>
        <input id="speedControl" type="range" min="0.97" max="1.5" value="1.09" step="0.01"
               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
      </div>

      <div class="space-y-2">
        <label for="styleControl" class="text-sm font-medium text-gray-400">Speech Visualizer Style</label>
        <select id="styleControl"
                class="w-full bg-gray-700 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="waveform">Waveform</option>
          <option value="bars">Frequency Bars</option>
        </select>
      </div>

      <div class="space-y-2">
        <label for="colorControl" class="text-sm font-medium text-gray-400">Color Scheme</label>
        <select id="colorControl"
                class="w-full bg-gray-700 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="orion">Orion Blue</option>
          <option value="retro">Retro Green</option>
          <option value="vaporwave">Vaporwave</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Floating Vision PiP -->
  <div
    id="visionFloatingContainer"
    class="hidden fixed bottom-4 right-4 w-64 h-40 bg-gray-900 border border-gray-700 rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col"
  >
    <div class="flex items-center justify-between px-3 py-1.5 border-b border-gray-800 text-xs text-gray-300 bg-gray-900/90">
      <span>Orion Vision (PiP)</span>
      <button id="visionCloseFloating" class="text-gray-400 hover:text-white">✕</button>
    </div>
    <div class="flex-1 bg-gray-800/70 flex items-center justify-center">
      <div class="text-[11px] text-gray-400 text-center px-3">
        Floating viewer stub. When vision is wired up, this will mirror the live feed with overlays.
      </div>
    </div>
  </div>

  <!-- The "?v=1.0.1" is a cache-busting parameter. -->
  <script src="/static/js/app.js?v=1.0.10" defer></script>
</body>
</html>
