services:
  vision-edge:
    build:
      context: ../..
      dockerfile: services/orion-vision-edge/Dockerfile
    container_name: ${PROJECT:-orion}-vision-edge
    restart: unless-stopped
    env_file:
      - .env

    environment:
      - SOURCE=${REOLINK_URL}
      - WIDTH=${WIDTH}
      - HEIGHT=${HEIGHT}
      - FPS=${FPS}

      - DETECTORS=${DETECTORS}
      - MOTION_MIN_AREA=${MOTION_MIN_AREA}
      - DETECT_EVERY_N_FRAMES=${DETECT_EVERY_N_FRAMES}
      - STREAM_ID=${STREAM_ID}
      - ENABLE_UI=${ENABLE_UI}

      - ENABLE_YOLO=${ENABLE_YOLO}
      - YOLO_MODEL=${YOLO_MODEL}
      - YOLO_CLASSES=${YOLO_CLASSES}
      - YOLO_CONF=${YOLO_CONF}
      - YOLO_DEVICE=${YOLO_DEVICE}

      - FACE_CASCADE_PATH=${FACE_CASCADE_PATH}
      - FACE_SCALE_FACTOR=${FACE_SCALE_FACTOR}
      - FACE_MIN_NEIGHBORS=${FACE_MIN_NEIGHBORS}
      - FACE_MIN_SIZE=${FACE_MIN_SIZE}

      - ANNOTATE=${ANNOTATE}

      - ENABLE_PRESENCE=${ENABLE_PRESENCE}
      - PRESENCE_TIMEOUT=${PRESENCE_TIMEOUT}
      - PRESENCE_LABEL=${PRESENCE_LABEL}

      - JPEG_QUALITY=${JPEG_QUALITY}

      - ORION_BUS_URL=${ORION_BUS_URL}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}

      - VISION_EVENTS_PUBLISH_RAW=${VISION_EVENTS_PUBLISH_RAW}
      - VISION_EVENTS_SUBSCRIBE_RAW=${VISION_EVENTS_SUBSCRIBE_RAW}
      - VISION_EVENTS_PUBLISH_NOTABLE=${VISION_EVENTS_PUBLISH_NOTABLE}

    volumes:
      - /mnt/telemetry/orion-vision-edge

    ports:
      - "7100:7100"

    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]

    networks:
      - app-net

networks:
  app-net:
    external: true
