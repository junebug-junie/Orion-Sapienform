services:
  notify:
    build:
      context: ../..
      dockerfile: services/orion-notify/Dockerfile
    container_name: ${PROJECT}-notify
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - NODE_NAME=${NODE_NAME}
      - PORT=${PORT}
      - API_TOKEN=${API_TOKEN}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}
      - ORION_BUS_ENFORCE_CATALOG=${ORION_BUS_ENFORCE_CATALOG}
      - ORION_BUS_URL=${ORION_BUS_URL}
      - NOTIFY_IN_APP_ENABLED=${NOTIFY_IN_APP_ENABLED}
      - NOTIFY_IN_APP_CHANNEL=${NOTIFY_IN_APP_CHANNEL}
      - POSTGRES_URI=${POSTGRES_URI}
      - POLICY_RULES_PATH=${POLICY_RULES_PATH}

      - NOTIFY_EMAIL_SMTP_HOST=${NOTIFY_EMAIL_SMTP_HOST}
      - NOTIFY_EMAIL_SMTP_PORT=${NOTIFY_EMAIL_SMTP_PORT}
      - NOTIFY_EMAIL_SMTP_USERNAME=${NOTIFY_EMAIL_SMTP_USERNAME}
      - NOTIFY_EMAIL_SMTP_PASSWORD=${NOTIFY_EMAIL_SMTP_PASSWORD}
      - NOTIFY_EMAIL_USE_TLS=${NOTIFY_EMAIL_USE_TLS}
      - NOTIFY_EMAIL_FROM=${NOTIFY_EMAIL_FROM}
      - NOTIFY_EMAIL_TO=${NOTIFY_EMAIL_TO}
      - NOTIFY_ESCALATION_POLL_SECONDS=${NOTIFY_ESCALATION_POLL_SECONDS}
      - NOTIFY_PRESENCE_URL=${NOTIFY_PRESENCE_URL}
      - NOTIFY_PRESENCE_TIMEOUT_SECONDS=${NOTIFY_PRESENCE_TIMEOUT_SECONDS}
      - NOTIFY_HUB_URL=${NOTIFY_HUB_URL}
    networks:
      - app-net
    ports:
      - "${PORT}:7140"
    volumes:
      - /mnt/telemetry/orion-notify:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7140/health"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-net:
    external: true
