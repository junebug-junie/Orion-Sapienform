services:
 security-watcher:
    build:
      context: ../..
      dockerfile: services/orion-security-watcher/Dockerfile
    container_name: ${PROJECT}-security-watcher
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - NODE_NAME=${NODE_NAME}
      # Bus
      - ORION_BUS_URL=${ORION_BUS_URL}
      - ORION_BUS_ENFORCE_CATALOG=${ORION_BUS_ENFORCE_CATALOG}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}

      # Vision events (subscribe to what edge publishes)
      - VISION_EVENTS_SUBSCRIBE_RAW=${VISION_EVENTS_PUBLISH_RAW}
      - CHANNEL_VISION_ARTIFACTS=${CHANNEL_VISION_ARTIFACTS}

      # Guard Config
      - CHANNEL_VISION_GUARD_SIGNAL=${CHANNEL_VISION_GUARD_SIGNAL}
      - CHANNEL_VISION_GUARD_ALERT=${CHANNEL_VISION_GUARD_ALERT}
      - GUARD_WINDOW_SECONDS=${GUARD_WINDOW_SECONDS}
      - GUARD_EMIT_EVERY_SECONDS=${GUARD_EMIT_EVERY_SECONDS}
      - GUARD_PERSON_MIN_CONF=${GUARD_PERSON_MIN_CONF}
      - GUARD_PERSON_MIN_COUNT=${GUARD_PERSON_MIN_COUNT}
      - GUARD_SUSTAIN_SECONDS=${GUARD_SUSTAIN_SECONDS}
      - GUARD_ALERT_COOLDOWN_SECONDS=${GUARD_ALERT_COOLDOWN_SECONDS}

      # Security event channels
      - CHANNEL_SECURITY_VISITS=${CHANNEL_SECURITY_VISITS}
      - CHANNEL_SECURITY_ALERTS=${CHANNEL_SECURITY_ALERTS}

      # Snapshot endpoint (vision edge HTTP)
      - VISION_SNAPSHOT_URL=${VISION_SNAPSHOT_URL}
      - VISION_SNAPSHOT_PUBLIC_URL=${VISION_SNAPSHOT_PUBLIC_URL}

      # Core security toggles
      - SECURITY_MIN_YOLO_SCORE=${SECURITY_MIN_YOLO_SCORE}

      # Visit / rate limiting
      - SECURITY_GLOBAL_COOLDOWN_SEC=${SECURITY_GLOBAL_COOLDOWN_SEC}
      - SECURITY_IDENTITY_COOLDOWN_SEC=${SECURITY_IDENTITY_COOLDOWN_SEC}
      - IDENTITY_CONFIDENCE_THRESHOLD=${IDENTITY_CONFIDENCE_THRESHOLD}

      # Snapshots
      - SECURITY_SNAPSHOT_COUNT=${SECURITY_SNAPSHOT_COUNT}
      - SECURITY_SNAPSHOT_INTERVAL_SEC=${SECURITY_SNAPSHOT_INTERVAL_SEC}
      - SECURITY_SNAPSHOT_DIR=${SECURITY_SNAPSHOT_DIR}

      # Notification mode + email
      - NOTIFY_MODE=${NOTIFY_MODE}
      - NOTIFY_EMAIL_ENABLED=${NOTIFY_EMAIL_ENABLED}
      - NOTIFY_EMAIL_SMTP_HOST=${NOTIFY_EMAIL_SMTP_HOST}
      - NOTIFY_EMAIL_SMTP_PORT=${NOTIFY_EMAIL_SMTP_PORT}
      - NOTIFY_EMAIL_SMTP_USERNAME=${NOTIFY_EMAIL_SMTP_USERNAME}
      - NOTIFY_EMAIL_SMTP_PASSWORD=${NOTIFY_EMAIL_SMTP_PASSWORD}
      - NOTIFY_EMAIL_USE_TLS=${NOTIFY_EMAIL_USE_TLS}
      - NOTIFY_EMAIL_FROM=${NOTIFY_EMAIL_FROM}
      - NOTIFY_EMAIL_TO=${NOTIFY_EMAIL_TO}

      # State file
      - SECURITY_STATE_PATH=${SECURITY_STATE_PATH}
    volumes:
      - /mnt/telemetry/orion-security:/mnt/telemetry/orion-security
      - /tmp/orion-frames:/mnt/frames
    networks:
      - app-net
    ports:
      - "7120:7120"

networks:
  app-net:
    external: true
