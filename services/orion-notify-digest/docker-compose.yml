services:
  notify-digest:
    build:
      context: ../..
      dockerfile: services/orion-notify-digest/Dockerfile
    container_name: ${PROJECT}-notify-digest
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - NODE_NAME=${NODE_NAME}
      - POSTGRES_URI=${POSTGRES_URI}
      - NOTIFY_SERVICE_URL=${NOTIFY_SERVICE_URL}
      - NOTIFY_API_TOKEN=${NOTIFY_API_TOKEN}
      - DIGEST_ENABLED=${DIGEST_ENABLED}
      - DIGEST_TIME_LOCAL=${DIGEST_TIME_LOCAL}
      - DIGEST_WINDOW_HOURS=${DIGEST_WINDOW_HOURS}
      - DIGEST_RECIPIENT_GROUP=${DIGEST_RECIPIENT_GROUP}
      - DIGEST_RUN_ON_START=${DIGEST_RUN_ON_START}
      - LANDING_PAD_URL=${LANDING_PAD_URL}
      - TOPICS_WINDOW_MINUTES=${TOPICS_WINDOW_MINUTES}
      - TOPICS_MAX_TOPICS=${TOPICS_MAX_TOPICS}
      - TOPICS_DRIFT_MIN_TURNS=${TOPICS_DRIFT_MIN_TURNS}
      - TOPICS_DRIFT_MAX_SESSIONS=${TOPICS_DRIFT_MAX_SESSIONS}
      - DRIFT_ALERTS_ENABLED=${DRIFT_ALERTS_ENABLED}
      - DRIFT_CHECK_INTERVAL_SECONDS=${DRIFT_CHECK_INTERVAL_SECONDS}
      - DRIFT_ALERT_THRESHOLD=${DRIFT_ALERT_THRESHOLD}
      - DRIFT_ALERT_MAX_ITEMS=${DRIFT_ALERT_MAX_ITEMS}
      - DRIFT_ALERT_SEVERITY=${DRIFT_ALERT_SEVERITY}
      - DRIFT_ALERT_EVENT_KIND=${DRIFT_ALERT_EVENT_KIND}
      - DRIFT_ALERT_DEDUPE_WINDOW_SECONDS=${DRIFT_ALERT_DEDUPE_WINDOW_SECONDS}
    networks:
      - app-net
    ports:
      - "7150:7150"
    volumes:
      - /mnt/telemetry/orion-notify:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7150/health"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-net:
    external: true
