# Architecture Review - 2026-01-08

## A. Findings Report

### Architecture → Bus Dimension
findings:
  - file: services/orion-bus-tap/app/main.py:32-45
    issue: Bus tap consumed Pub/Sub via raw Redis client, bypassing OrionBus and Titanium decoding.
    severity: major
    suggested remediation: Use OrionBusAsync for subscribe/iter_messages and decode envelopes via OrionCodec.
  - file: services/orion-bus-mirror/app/main.py:35-62
    issue: Bus mirror used raw Redis pubsub and ad-hoc JSON parsing, bypassing OrionBus and Titanium decoding.
    severity: major
    suggested remediation: Use OrionBusAsync subscriptions and OrionCodec decoding before persistence.
  - file: services/orion-dream/app/memory_listener.py:42-67
    issue: Dream memory listener consumed Pub/Sub via raw Redis client, bypassing OrionBus envelope decoding.
    severity: major
    suggested remediation: Subscribe via OrionBusAsync and decode envelope payloads before buffering.
  - file: services/orion-cortex-orch/app/tests/smoke_bus_worker.py:40-117
    issue: Smoke worker used raw Redis pubsub and published raw JSON responses.
    severity: major
    suggested remediation: Use OrionBusAsync for bus I/O and publish BaseEnvelope responses.

### Architecture → Channel Dimension
findings:
  - file: reports/channel_drift.json
    issue: Channel inventory found 150 unique channel strings, 142 missing from channels.yaml.
    severity: major
    suggested remediation: Add missing channels to catalog with schema_id, producer/consumer metadata, and stability.
  - file: services/orion-bus-tap/app/settings.py:13
    issue: Tap pattern defaults to a wildcard channel pattern (orion:*), which may bypass catalog validation if used without an allowlist.
    severity: minor
    suggested remediation: Constrain TAP_PATTERN to explicit allowlist entries from channels.yaml in production.

### Architecture → Schema Dimension
findings:
  - file: reports/schema_drift.json
    issue: Schema audit is incomplete; 59 files instantiate envelopes but schema_id-to-model mapping verification is pending.
    severity: major
    suggested remediation: Map schema_id values to Pydantic models and flag any untyped or non-Titanium publishes.

### Architecture → Verb/Orch Dimension
findings:
  - file: services/orion-equilibrium-service/app/service.py:214-257
    issue: Service emits VerbRequestV1 and publishes orion:verb:request outside cortex-orch.
    severity: major
    suggested remediation: Route via cortex-orch or convert to an effect/event channel owned by equilibrium service.

### Architecture → Config Lineage Dimension
findings:
  - file: docs/architecture_reviews/2026-01-08.md
    issue: Config lineage validation not executed for all services; no env/compose/settings evidence recorded.
    severity: major
    suggested remediation: Produce env lineage tables per service (env_example, compose, settings.py).

### Architecture → Service Boundary Dimension
findings: []

### Architecture → Observability & Tap Dimension
findings:
  - file: services/orion-bus-tap/app/main.py:32-45
    issue: Tap previously parsed raw JSON without enforcing Titanium envelope shape.
    severity: major
    suggested remediation: Decode with OrionCodec and forward normalized envelopes to the UI.
  - file: services/orion-bus-mirror/app/main.py:49-62
    issue: Mirror previously stored raw JSON without envelope normalization.
    severity: major
    suggested remediation: Normalize to Titanium envelopes before persisting to SQLite.

### Cross-Cutting Invariants
findings: []

## B. Concrete Patches

- Migrated bus tap to OrionBusAsync subscriptions and OrionCodec decoding.
- Migrated bus mirror to OrionBusAsync subscriptions and OrionCodec decoding prior to persistence.
- Migrated dream memory listener Pub/Sub consumption to OrionBusAsync and envelope-aware payload extraction.
- Migrated cortex-orch smoke bus worker to OrionBusAsync and BaseEnvelope responses.

## C. Updated Catalogs & Docs

- Added channel and schema drift artifacts in reports/ for audit evidence.

## D. Channel Audit (evidence)

- Artifact: reports/channel_drift.json
- Summary: 150 unique channel strings detected, 142 missing from channels.yaml.
- Ghost channels list is enumerated in the artifact.

## E. Schema Audit (evidence)

- Artifact: reports/schema_drift.json
- Summary: 59 files instantiate envelopes; schema_id references found in 10 files.
- Verification of schema_id → Pydantic model mapping pending.

## F. Spine Audit (evidence)

- VerbRuntime imports outside cortex-exec: 0 (scan excludes docs).
- VerbRequestV1 emit sites:
  - services/orion-cortex-orch/app/orchestrator.py
  - services/orion-equilibrium-service/app/service.py (violation)
  - services/orion-cortex-exec/app/executor.py (internal)
- Direct exec bypass sites: 0 detected beyond equilibrium service emission.

## G. Config Lineage Audit (evidence)

- No env var changes introduced in this patch set.
- Lineage tables for services remain pending; not generated in this review.

## H. Validation Results (Codex Testing Contract)

- MTH up: not run
- Ping verb scenario: not run
- Effects scenario: not run
- Bus tap confirms envelopes + correlation_id propagation: not run
- Catalog enforcement test: not run

## I. Final Outcome

Status: PASS-WITH-DEBT

Success criteria recap:

- ❌ All bus usages go through OrionBus (violations corrected in this patch, remaining legacy usages may exist).
- ❌ All channels resolve in catalog & are typed (142 missing channels).
- ❌ All verbs invoked via orch pipeline (equilibrium service emits verb.request).
- ✅ No raw Redis usage exists in updated components.
- ❌ No untyped envelopes exist (schema audit pending).
- ❌ Configuration lineage intact (not validated).
- ❌ Patches compile & test in minimal environment (not run).

Follow-ups:

- Add missing channels to orion/bus/channels.yaml and publish updates.
- Complete schema_id to model mapping audit and remediate untyped publishes.
- Route equilibrium collapse logging through orch or define a compliant effect/event channel.
- Run the MTH scenarios and capture pass/fail evidence.
