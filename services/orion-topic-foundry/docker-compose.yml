services:
  topic-foundry:
    build:
      context: ../..
      dockerfile: services/orion-topic-foundry/Dockerfile
    container_name: orion-${NODE_NAME}-topic-foundry
    restart: unless-stopped
    networks:
      - app-net
    environment:
      - SERVICE_NAME=${SERVICE_NAME}
      - SERVICE_VERSION=${SERVICE_VERSION}
      - NODE_NAME=${NODE_NAME}
      - LOG_LEVEL=${LOG_LEVEL}
      - PORT=${PORT}
      - TOPIC_FOUNDRY_PG_DSN=${TOPIC_FOUNDRY_PG_DSN}
      - TOPIC_FOUNDRY_EMBEDDING_URL=${TOPIC_FOUNDRY_EMBEDDING_URL}
      - TOPIC_FOUNDRY_COSINE_IMPL=${TOPIC_FOUNDRY_COSINE_IMPL:-normalize_euclidean}
      - TOPIC_FOUNDRY_MODEL_DIR=${TOPIC_FOUNDRY_MODEL_DIR}
      - TOPIC_FOUNDRY_LLM_ROUTE=${TOPIC_FOUNDRY_LLM_ROUTE}
      - TOPIC_FOUNDRY_LLM_TIMEOUT_SECS=${TOPIC_FOUNDRY_LLM_TIMEOUT_SECS}
      - TOPIC_FOUNDRY_LLM_MAX_CONCURRENCY=${TOPIC_FOUNDRY_LLM_MAX_CONCURRENCY}
      - TOPIC_FOUNDRY_LLM_USE_BUS=${TOPIC_FOUNDRY_LLM_USE_BUS}
      - TOPIC_FOUNDRY_LLM_INTAKE_CHANNEL=${TOPIC_FOUNDRY_LLM_INTAKE_CHANNEL}
      - TOPIC_FOUNDRY_LLM_REPLY_PREFIX=${TOPIC_FOUNDRY_LLM_REPLY_PREFIX}
      - TOPIC_FOUNDRY_LLM_ENABLE=${TOPIC_FOUNDRY_LLM_ENABLE}
      - ORION_BUS_ENABLED=${ORION_BUS_ENABLED}
      - ORION_BUS_URL=${ORION_BUS_URL}
      - TOPIC_FOUNDRY_DRIFT_DAEMON=${TOPIC_FOUNDRY_DRIFT_DAEMON}
      - TOPIC_FOUNDRY_DRIFT_POLL_SECONDS=${TOPIC_FOUNDRY_DRIFT_POLL_SECONDS}
      - TOPIC_FOUNDRY_DRIFT_WINDOW_HOURS=${TOPIC_FOUNDRY_DRIFT_WINDOW_HOURS}
      - TOPIC_FOUNDRY_INTROSPECT_SCHEMAS=${TOPIC_FOUNDRY_INTROSPECT_SCHEMAS:-public}
      - TOPIC_FOUNDRY_INTROSPECT_CACHE_SECS=${TOPIC_FOUNDRY_INTROSPECT_CACHE_SECS:-30}
      - TOPIC_FOUNDRY_INTROSPECT_MAX_TABLES=${TOPIC_FOUNDRY_INTROSPECT_MAX_TABLES:-5000}
      - TOPIC_FOUNDRY_INTROSPECT_MAX_COLUMNS=${TOPIC_FOUNDRY_INTROSPECT_MAX_COLUMNS:-5000}
      - TOPIC_FOUNDRY_TOPIC_ENGINE=${TOPIC_FOUNDRY_TOPIC_ENGINE}
      - TOPIC_FOUNDRY_EMBEDDING_BACKEND=${TOPIC_FOUNDRY_EMBEDDING_BACKEND}
      - TOPIC_FOUNDRY_EMBEDDING_MODEL=${TOPIC_FOUNDRY_EMBEDDING_MODEL}
      - TOPIC_FOUNDRY_VECTOR_HOST_URL=${TOPIC_FOUNDRY_VECTOR_HOST_URL}
      - TOPIC_FOUNDRY_EMBEDDING_BATCH_SIZE=${TOPIC_FOUNDRY_EMBEDDING_BATCH_SIZE}
      - TOPIC_FOUNDRY_EMBEDDING_MAX_RETRIES=${TOPIC_FOUNDRY_EMBEDDING_MAX_RETRIES}
      - TOPIC_FOUNDRY_EMBEDDING_RETRY_DELAY_SECS=${TOPIC_FOUNDRY_EMBEDDING_RETRY_DELAY_SECS}
      - TOPIC_FOUNDRY_REDUCER=${TOPIC_FOUNDRY_REDUCER}
      - TOPIC_FOUNDRY_CLUSTERER=${TOPIC_FOUNDRY_CLUSTERER}
      - TOPIC_FOUNDRY_REPRESENTATION=${TOPIC_FOUNDRY_REPRESENTATION}
      - TOPIC_FOUNDRY_RANDOM_STATE=${TOPIC_FOUNDRY_RANDOM_STATE}
      - TOPIC_FOUNDRY_UMAP_N_NEIGHBORS=${TOPIC_FOUNDRY_UMAP_N_NEIGHBORS}
      - TOPIC_FOUNDRY_UMAP_N_COMPONENTS=${TOPIC_FOUNDRY_UMAP_N_COMPONENTS}
      - TOPIC_FOUNDRY_UMAP_MIN_DIST=${TOPIC_FOUNDRY_UMAP_MIN_DIST}
      - TOPIC_FOUNDRY_UMAP_METRIC=${TOPIC_FOUNDRY_UMAP_METRIC}
      - TOPIC_FOUNDRY_HDBSCAN_MIN_CLUSTER_SIZE=${TOPIC_FOUNDRY_HDBSCAN_MIN_CLUSTER_SIZE}
      - TOPIC_FOUNDRY_HDBSCAN_MIN_SAMPLES=${TOPIC_FOUNDRY_HDBSCAN_MIN_SAMPLES}
      - TOPIC_FOUNDRY_HDBSCAN_METRIC=${TOPIC_FOUNDRY_HDBSCAN_METRIC}
      - TOPIC_FOUNDRY_HDBSCAN_CLUSTER_SELECTION_METHOD=${TOPIC_FOUNDRY_HDBSCAN_CLUSTER_SELECTION_METHOD}
      - TOPIC_FOUNDRY_VECTORIZER_NGRAM_MIN=${TOPIC_FOUNDRY_VECTORIZER_NGRAM_MIN}
      - TOPIC_FOUNDRY_VECTORIZER_NGRAM_MAX=${TOPIC_FOUNDRY_VECTORIZER_NGRAM_MAX}
      - TOPIC_FOUNDRY_VECTORIZER_MIN_DF=${TOPIC_FOUNDRY_VECTORIZER_MIN_DF}
      - TOPIC_FOUNDRY_VECTORIZER_MAX_DF=${TOPIC_FOUNDRY_VECTORIZER_MAX_DF}
      - TOPIC_FOUNDRY_VECTORIZER_MAX_FEATURES=${TOPIC_FOUNDRY_VECTORIZER_MAX_FEATURES}
      - TOPIC_FOUNDRY_TOP_N_WORDS=${TOPIC_FOUNDRY_TOP_N_WORDS}
      - TOPIC_FOUNDRY_ENABLE_CLASS_BASED=${TOPIC_FOUNDRY_ENABLE_CLASS_BASED}
      - TOPIC_FOUNDRY_ENABLE_LONG_DOCUMENT=${TOPIC_FOUNDRY_ENABLE_LONG_DOCUMENT}
      - TOPIC_FOUNDRY_ENABLE_HIERARCHICAL=${TOPIC_FOUNDRY_ENABLE_HIERARCHICAL}
      - TOPIC_FOUNDRY_ENABLE_DYNAMIC=${TOPIC_FOUNDRY_ENABLE_DYNAMIC}
      - TOPIC_FOUNDRY_ENABLE_GUIDED=${TOPIC_FOUNDRY_ENABLE_GUIDED}
      - TOPIC_FOUNDRY_ENABLE_ZEROSHOT=${TOPIC_FOUNDRY_ENABLE_ZEROSHOT}
    volumes:
      - /mnt/telemetry/models/topic-foundry:/mnt/telemetry/models/topic-foundry
    env_file:
      - .env
    ports:
      - "${PORT}:${PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT}/health"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-net:
    external: true
