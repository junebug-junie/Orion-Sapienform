# services/orion-spark-introspector/docker-compose.yml
services:
  spark-introspector:
    build:
      context: ../..
      dockerfile: services/orion-spark-introspector/Dockerfile
    container_name: ${PROJECT}-spark-introspector
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - app-net
    environment:
      PROJECT: ${PROJECT}
      NODE_NAME: ${NODE_NAME}
      SERVICE_NAME: ${SERVICE_NAME}
      SERVICE_VERSION: ${SERVICE_VERSION}

      ORION_BUS_URL: ${ORION_BUS_URL}
      ORION_BUS_ENFORCE_CATALOG: ${ORION_BUS_ENFORCE_CATALOG}
      ORION_BUS_ENABLED: ${ORION_BUS_ENABLED}
      HEARTBEAT_INTERVAL_SEC: ${HEARTBEAT_INTERVAL_SEC}
      PORT: ${PORT}

      # Bus channels
      CHANNEL_COGNITION_TRACE_PUB: ${CHANNEL_COGNITION_TRACE_PUB:-orion:cognition:trace}
      CHANNEL_SPARK_TELEMETRY: ${CHANNEL_SPARK_TELEMETRY:-orion:spark:telemetry}
      CHANNEL_SPARK_STATE_SNAPSHOT: ${CHANNEL_SPARK_STATE_SNAPSHOT:-orion:spark:state:snapshot}
      CHANNEL_SPARK_INTROSPECT_CANDIDATE: ${CHANNEL_SPARK_INTROSPECT_CANDIDATE:-orion:spark:introspect:candidate*}
      CHANNEL_SPARK_SIGNAL: ${CHANNEL_SPARK_SIGNAL:-orion:spark:signal}
      CHANNEL_VECTOR_SEMANTIC_UPSERT: ${CHANNEL_VECTOR_SEMANTIC_UPSERT:-orion:vector:semantic:upsert}
      CHANNEL_EMBEDDING_GENERATE: ${CHANNEL_EMBEDDING_GENERATE:-orion:embedding:generate}
      EMBEDDING_RESULT_PREFIX: ${EMBEDDING_RESULT_PREFIX:-orion:embedding:result:}
      VALENCE_ANCHOR_POS_TEXT: ${VALENCE_ANCHOR_POS_TEXT:-I feel hopeful and grateful.}
      VALENCE_ANCHOR_NEG_TEXT: ${VALENCE_ANCHOR_NEG_TEXT:-I feel hopeless and afraid.}
      VALENCE_GAIN: ${VALENCE_GAIN:-0.35}
      VALENCE_ANCHOR_REFRESH_SEC: ${VALENCE_ANCHOR_REFRESH_SEC:-21600}
      VALENCE_ANCHOR_TIMEOUT_SEC: ${VALENCE_ANCHOR_TIMEOUT_SEC:-10}
      CORTEX_REQUEST_CHANNEL: ${CORTEX_REQUEST_CHANNEL:-orion:cortex:request}

      # Freshness
      SPARK_STATE_VALID_FOR_MS: ${SPARK_STATE_VALID_FOR_MS:-15000}

      # Tissue
      ORION_TISSUE_SNAPSHOT_PATH: ${ORION_TISSUE_SNAPSHOT_PATH:-/mnt/storage-lukewarm/orion/spark/tissue-brain.npy}

      # Cortex timeouts
      CORTEX_TIMEOUT_SEC: ${CORTEX_TIMEOUT_SEC:-120}

    ports:
      - "${PORT:-8444}:${PORT:-8444}"

    volumes:
      - /mnt/storage-lukewarm/orion/spark:/mnt/storage-lukewarm/orion/spark

networks:
  app-net:
    external: true
